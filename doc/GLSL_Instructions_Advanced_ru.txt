Инструкция по использованию алгоритма масштабирования Anime4K

У Anime4K есть 3 основных режима, так как небольшие сети CNN не могут эффективно изучать каждый тип смещения распределения
и деградация, наблюдаемая в дикой природе. Человеческое суждение послужит (пока) временным решением. Обычно правильный
режим тот, который выглядит лучше всего.

Самый простой способ - сначала визуально осмотреть каждый режим в порядке A-B-C. Режим A при неправильном использовании имеет наиболее заметные артефакты из
трех режимов. B и C может быть сложнее различить для аниме с более низким разрешением.

Если вы хотите повысить качество восприятия, используйте соответствующий дополнительный режим.

| Основной режим | Соответствующий дополнительный режим |
|----------------|--------------------------------------|
| A              | A+A                                  |
| B              | B+B                                  |
| C              | C+A                                  |

Вот для чего оптимизирован каждый режим и что он делает:

Режим: A
Оптимизировано для: большинства аниме 1080p, некоторых старых аниме 720p, большинства старых аниме SD (сильное размытие), (много артефактов передискретизации), (размазывание из-за сжатия).
Положительные эффекты: Высокое качество восприятия. Уменьшает артефакты сжатия. Восстанавливает наиболее поврежденные линии. Уменьшает сильное размытие. Уменьшает шум.
Отрицательные эффекты (при неправильном использовании): может усиливать звон, если он уже присутствует. Может усиливать полосатость, если она уже присутствует. Сильное шумоподавление может размыть текстуры.

Режим: B
Оптимизирован для: Некоторых аниме 1080p. Большинство аниме 720p. Аниме с уменьшенным масштабом 1080p -> 720p (Низкое размытие) (Некоторые артефакты ресемплинга) (Звук из-за понижения дискретизации).
Положительные эффекты: Уменьшает артефакты сжатия. Восстанавливает некоторые ухудшенные линии. Уменьшает некоторое размытие. Уменьшает шум. Уменьшает звон. Уменьшает алиасинг.
Отрицательные эффекты (при неправильном использовании): некоторые артефакты могут не удаляться, некоторые линии могут оставаться размытыми, сильное шумоподавление может размывать текстуры.

Режим: C
Оптимизировано для: 1080p->480p уменьшенное аниме. Очень редко, 1080p анимационные фильмы. Изображения без деградации. Обои Pixiv art.
Положительные эффекты: Самый высокий PSNR. Снижает уровень шума.
Отрицательные эффекты (при неправильном использовании): низкое качество восприятия; может усиливать звон, если он уже присутствует; может усиливать артефакты повторной выборки.

Режим: А+А*
Оптимизировано для: То же, что и A
Положительные эффекты: Высочайшее качество восприятия. Восстанавливает почти все поврежденные линии. Те же положительные эффекты, что и в режиме А.
Негативные эффекты (при неправильном использовании): Может вызвать сильный звон. Может вызвать полосатость. Может вызвать алиасинг. Те же отрицательные эффекты, что и в режиме А. Медленнее, чем в режиме А.

Режим: B+B*
Оптимизировано для: То же, что и B.
Положительные эффекты: Высокое качество восприятия. Те же положительные эффекты, что и в режиме B.
Отрицательные эффекты (при неправильном использовании): такие же отрицательные эффекты от режима B, ниже, чем от режима B.

Режим: C+A*
Оптимизировано для: То же, что и C
Положительные эффекты: Чуть более высокое качество восприятия. Те же положительные эффекты, что и в режиме C.
Отрицательные эффекты (при неправильном использовании): те же негативные эффекты, что и в режиме C, ниже, чем в режиме C.

*Эти режимы следует использовать только при коэффициентах масштабирования x2 или выше. Если у вас экран с разрешением 1080p, при использовании режима A на
Аниме 1080p улучшит качество изображения, но режим A+A, скорее всего, приведет к чрезмерной резкости и ухудшению изображения.

Расширенная настройка

Вас не устраивает простое использование параметров по умолчанию? Любопытно узнать о неподдерживаемых/странных режимах, таких как B+A, A+B или B+A+А? Это краткое руководство поможет вам приступить к настройке собственного конвейера восстановления.

Во-первых, основы:
• Все шейдеры можно использовать отдельно или в сочетании с любыми другими шейдерами.
• Вы можете использовать каждый файл шейдера только один раз. Использование одного и того же файла два или более раз приводит к ошибкам в работе и потере
  производительность. Либо используйте другой вариант, либо скопируйте и переименуйте повторяющиеся шейдеры.
• Шейдеры обрабатывают изображение в том же порядке, в котором имена файлов указаны в input.conf. Одно исключение
  Clamp_Highlights, поясняется в таблице ниже.
• Вы можете выбрать вариант CNN (S, M, L, VL, UL) для лучшей скорости или качества. Каждый шаг в размере для CNN
  шейдеры удваивает время обработки. Например, если для запуска версии M требуется 5 мс, для версии L требуется
  примерно 10 мс для запуска, 20 мс для VL и так далее.
• Шейдеры, отличные от CNN, работают значительно быстрее, но могут иметь более низкое качество.

Краткое объяснение каждого типа шейдера:
Restore - шейдер, который отличает Anime4K от других апскейлеров. Восстанавливает изображение, лучше всего использовать перед масштабированием. Удаляет артефакты сжатия, размытие, звон и т. д. Restore более оптимизирован для артефактов повышения дискретизации и размытия, а Restore_Soft более оптимизирован для артефактов понижения дискретизации и алиасинга.
Upscale - масштабирует изображение в 2 раза, предполагая, что изображение не имеет искажений.
Upscale_Denoise - масштабирует изображение в 2 раза и удаляет шумы без снижения производительности графического процессора.
Clamp_Highlights - вычисляет и сохраняет статистику изображения в том месте, где оно находится на этапе шейдера, а затем фиксирует светлые участки изображения в конце после всех шейдеров, чтобы предотвратить перерегулирование и уменьшить звон.
Darken - затемняет линии на изображении. Поскольку то, что составляет линию, неоднозначно, может затемнить другие вещи. Используйте в соответствии с личным вкусом.
Thin - делает линии на изображении тоньше. Поскольку то, что составляет линию, неоднозначно, может истончить другие вещи. Используйте в соответствии с личным вкусом.
Denoise - применяет фильтр шумоподавления к изображению.
Deblur - применяет к изображению фильтр размытия. Делает детали более резкими без перерегулирования или звона.
AutoDownscalePre_x4 - уменьшает изображение после первого шага увеличения, чтобы второй шаг увеличения x2 точно соответствовал размеру экрана. Это повышает производительность без заметного влияния на качество, поскольку вы не будете работать с изображениями, размер которых превышает размер экрана. Должен быть размещен между двумя шейдерами Upscale. Без этого шейдера поведение по умолчанию заключается в уменьшении до размера экрана после запуска всех шейдеров.
AutoDownscalePre_x2 - уменьшает изображение после первого шага увеличения, чтобы оно соответствовало размеру экрана. Это повышает производительность без заметного влияния на качество, поскольку вы не будете работать с изображениями, размер которых превышает размер экрана. Должен располагаться после первого шейдера Upscale. Без этого шейдера поведение по умолчанию заключается в уменьшении до размера экрана после запуска всех шейдеров.


Обзор режимов по умолчанию:

| Mode | Shaders                                            |
|------|----------------------------------------------------|
| A    | Restore -> Upscale -> Upscale                      |
| B    | Restore_Soft -> Upscale -> Upscale                 |
| C    | Upscale_Denoise -> Upscale                         |
| A+A  | Restore -> Upscale -> Restore -> Upscale           |
| B+B  | Restore_Soft -> Upscale -> Restore_Soft -> Upscale |
| C+A  | Upscale_Denoise -> Restore -> Upscale              |


Примечание. Clamp_Highlights и AutoDownscalePre были удалены из таблицы для наглядности.
 Как определяются режимы:
    • Режим A изначально определяется как: Restore -> Upscale.
    • Режим B изначально определяется как: Restore_Soft -> Upscale.
    • Режим C изначально определяется как: Upscale
    • Если режим не начинается с шейдера Restore, он должен начинаться с шейдера Upscale_Denoise или Denoise, т.к.
      почти каждый алгоритм сжатия видео работает с потерями.
    • Все режимы должны добавлять шейдеры с улучшенным масштабированием до тех пор, пока весь конвейер шейдеров не будет масштабироваться как минимум в 4 раза. Разумный
      предполагается, что наименьший разумный размер видео составляет 480p, а самый большой экран — 4K, 4-кратное масштабирование
      близко к 4,5x 480p-> 4K.

С приведенными выше определениями мы можем увидеть, например, что такое C+A+B.
   1. Исходное определение:
      C (Upscale) -> A (Restore -> Upscale) -> B (Restore_Soft -> Upscale)
   2. Все режимы должны начинаться с restore/denoise:
      C (Upscale_Denoise) -> A (Restore -> Upscale) -> B (Restore_Soft -> Upscale)
   3. Соотношение апскейла 4х уже достигнуто.
   4. С+А+В это:
      Upscale_Denoise -> Restore -> Upscale -> Restore_Soft -> Upscale
   5. Варианты шейдеров (S/M/L/VL/UL) можно выбирать по желанию.

Рекомендации

Рекомендуется всегда включать Clamp_Highlights в начале, чтобы предотвратить звон в некоторых аниме, но
удаление его немного улучшит скорость.

Добавление шейдера восстановления после шага масштабирования улучшает качество восприятия, но замедляет обработку и может
вводить артефакты.

Шейдеры, примененные после шага масштабирования x2, займут в четыре раза больше времени обработки. Например, если шейдеру требуется 10 мс для
run при размещении перед апскейлером, ему потребуется 40 мс, если он будет помещен после апскейлера. Противодействовать этому можно с помощью
меньший вариант CNN двумя шагами ниже. (например, S вместо L).

Артефакты, вносимые шейдерами более низкого качества (например, вариантами M или S), обычно незаметны при работе на очень высоких настройках
резолюции. Это преимущество может быть использовано для снижения шума/нагрева и энергопотребления вентилятора графического процессора, если вы не против немного понизить его
качество изображения.

Цель для видео с частотой 24 кадра в секунду обычно составляет ~ 41 мс. Пропуски кадров появятся, если графический процессор не поспевает за ними. Если это произойдет, используйте
варианты шейдеров более низкого качества/быстрее. Используйте профилировщик mpv (нажмите Shift+I, а затем 2 в верхнем ряду клавиатуры), чтобы проверить, сможет ли ваш GPU идти в ногу со временем.

| Video Framerate | Maximum time (ms) |
|-----------------|-------------------|
| 24              | 41                |
| 30              | 33                |
| 60              | 16                |
